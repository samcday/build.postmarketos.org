name: Build Phosh Image Artifacts

on:
  workflow_dispatch:
    inputs:
      device:
        description: Device to build (blank means all)
        required: false
        default: ""
      pmaports_ref:
        description: pmaports ref to build
        required: false
        default: master
      apk_repo_base_url:
        description: Override APK repo base URL
        required: false
        default: https://pmos.samcday.com
      apk_repo_key_url:
        description: Override APK repo public key URL
        required: false
        default: https://pmos.samcday.com/pmos.samcday.com.rsa.pub

permissions:
  contents: read

concurrency:
  group: build-phosh-image-artifacts-${{ github.ref }}-${{ github.event.inputs.device || 'all' }}
  cancel-in-progress: true

jobs:
  select-devices:
    runs-on: ubuntu-24.04
    outputs:
      matrix: ${{ steps.select.outputs.matrix }}
    steps:
      - id: select
        name: Select build matrix
        run: |
          selected="${{ github.event.inputs.device }}"

          case "${selected}" in
            "")
              matrix='[{"device":"db410c","pmbootstrap_device":"arrow-db410c","override_packages":"linux-postmarketos-qcom-msm8916"},{"device":"samsung-a5u-eur","pmbootstrap_device":"samsung-a5","override_packages":"linux-postmarketos-qcom-msm8916"},{"device":"oneplus-fajita","pmbootstrap_device":"oneplus-fajita","override_packages":"linux-postmarketos-qcom-sdm845"},{"device":"oneplus-enchilada","pmbootstrap_device":"oneplus-enchilada","override_packages":"linux-postmarketos-qcom-sdm845"}]'
              ;;
            db410c|arrow-db410c)
              matrix='[{"device":"db410c","pmbootstrap_device":"arrow-db410c","override_packages":"linux-postmarketos-qcom-msm8916"}]'
              ;;
            samsung-a5u-eur|samsung-a5)
              matrix='[{"device":"samsung-a5u-eur","pmbootstrap_device":"samsung-a5","override_packages":"linux-postmarketos-qcom-msm8916"}]'
              ;;
            oneplus-fajita)
              matrix='[{"device":"oneplus-fajita","pmbootstrap_device":"oneplus-fajita","override_packages":"linux-postmarketos-qcom-sdm845"}]'
              ;;
            oneplus-enchilada)
              matrix='[{"device":"oneplus-enchilada","pmbootstrap_device":"oneplus-enchilada","override_packages":"linux-postmarketos-qcom-sdm845"}]'
              ;;
            *)
              echo "Unsupported device '${selected}'"
              echo "Allowed values: db410c, samsung-a5u-eur, oneplus-fajita, oneplus-enchilada"
              exit 1
              ;;
          esac

          echo "Building device selection: ${selected:-all}"
          echo "matrix=${matrix}" >> "${GITHUB_OUTPUT}"

  build:
    needs: select-devices
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 420
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(needs.select-devices.outputs.matrix) }}
    env:
      DEVICE: ${{ matrix.pmbootstrap_device }}
      DEVICE_ARTIFACT_NAME: ${{ matrix.device }}
      OVERRIDE_PACKAGES: ${{ matrix.override_packages }}
      UI: phosh
      PMOS_VER: edge
      IMAGE_PASSWORD: "147147"
      PMAPORTS_REPO: samcday/pmaports
      PMAPORTS_REF: ${{ github.event.inputs.pmaports_ref || 'master' }}
      APK_REPO_BASE_URL: ${{ github.event.inputs.apk_repo_base_url || vars.APK_REPO_BASE_URL || 'https://pmos.samcday.com' }}
      APK_REPO_KEY_URL: ${{ github.event.inputs.apk_repo_key_url || vars.APK_REPO_KEY_URL || 'https://pmos.samcday.com/pmos.samcday.com.rsa.pub' }}
    steps:
      - name: Checkout build.postmarketos.org
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout pmaports mirror
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PMAPORTS_REPO }}
          ref: ${{ env.PMAPORTS_REF }}
          path: pmaports
          fetch-depth: 0

      - name: Validate override APK repo URLs
        run: |
          set -euo pipefail

          apk_repo_base_url="${APK_REPO_BASE_URL%/}"
          apk_repo_key_url="${APK_REPO_KEY_URL:-}"

          if [ -z "${apk_repo_base_url}" ]; then
            echo "APK_REPO_BASE_URL must not be empty"
            exit 1
          fi

          if ! curl -fsSLI "${apk_repo_base_url}/aarch64/APKINDEX.tar.gz" >/dev/null; then
            if ! curl -fsSLI "${apk_repo_base_url}/master/aarch64/APKINDEX.tar.gz" >/dev/null; then
              echo "Failed to reach override APKINDEX under ${apk_repo_base_url}"
              exit 1
            fi
          fi

          if [ -z "${apk_repo_key_url}" ]; then
            if curl -fsSLI "${apk_repo_base_url}/pmos.samcday.com.rsa.pub" >/dev/null; then
              apk_repo_key_url="${apk_repo_base_url}/pmos.samcday.com.rsa.pub"
            elif curl -fsSLI "${apk_repo_base_url}/master/pmos.samcday.com.rsa.pub" >/dev/null; then
              apk_repo_key_url="${apk_repo_base_url}/master/pmos.samcday.com.rsa.pub"
            else
              echo "Failed to find override repo key under ${apk_repo_base_url}"
              exit 1
            fi
          fi

          if ! curl -fsSLI "${apk_repo_key_url}" >/dev/null; then
            echo "Failed to reach override repo key URL: ${apk_repo_key_url}"
            exit 1
          fi

          echo "Using override repo base URL: ${apk_repo_base_url}"
          echo "Using override repo key URL: ${apk_repo_key_url}"
          echo "APK_REPO_BASE_URL=${apk_repo_base_url}" >> "${GITHUB_ENV}"
          echo "APK_REPO_KEY_URL=${apk_repo_key_url}" >> "${GITHUB_ENV}"

      - name: Set up pmbootstrap
        run: |
          bash .github/scripts/setup-pmbootstrap.sh \
            "${GITHUB_WORKSPACE}/pmaports" \
            "${DEVICE}" \
            "${UI}" \
            "${PMOS_VER}"

      - name: Build BPO-style image artifacts
        run: |
          bash .github/scripts/build-phosh-artifacts.sh \
            "${GITHUB_WORKSPACE}/pmaports" \
            "${DEVICE}" \
            "${PMOS_VER}" \
            "${UI}" \
            "${OVERRIDE_PACKAGES}" \
            "${DEVICE_ARTIFACT_NAME}"

      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: phosh-images-${{ matrix.device }}
          path: out/
